#!/bin/bash

ME="$0"

export LC_ALL="C"

err() {
	echo "$ME: $*" >&2
	exit 1
}

## only want to run as unprivileged user
[ `whoami` == 'root' ] && err "dont wanna run as root"

ZIMBRA_ROOT="$HOME"
PATH="$ZIMBRA_ROOT/bin:$PATH"

zmpkg_devinit() {
	if [ ! "$1" ]; then
		echo "$ME <zimbra-root>"
		exit 2
	fi
	local ORIGINAL_ZIMBRA_ROOT="$1"

	if [ `whoami` == "zimbra" ]; then
		echo "$ME: never run devel-init as the zimbra user - it would destroy your zimbra installation !" >&2
		exit 3
	fi

	if [ ! "$ZIMBRA_BASE" ]; then
		echo "$ME: you need to set ZIMBRA_BASE variable to your current zimbra major version (eg. helix)" >&2
		exit 4
	fi

	## dummy for zmzimletctl
	(
	    echo '#!/bin/bash'
	    echo ''
	    echo 'echo "zimletctl dummy: " $0 $*'
	    echo 'exit 0'
	) > $ZIMBRA_ROOT/bin/zmzimletctl
	chmod +x $ZIMBRA_ROOT/bin/zmzimletctl

	## dummy for zmskindeploy
	(
	    echo '#!/bin/bash'
	    echo ''
	    echo 'echo "zmskindeploy dummy: " $0 $*'
	    echo 'exit 0'
	) > $ZIMBRA_ROOT/bin/zmskindeploy
	chmod +x $ZIMBRA_ROOT/bin/zmskindeploy

	## global libdir
	local dirlist="lib/jars jetty/lib jetty/lib/ext jetty/lib/naming jetty/lib/plus jetty/lib/jsp-2.1 jetty/lib/jsp"
	for i in $dirlist ; do
		mkdir -p $ZIMBRA_ROOT/$i || err "failed to create $ZIMBRA_ROOT/$i"
		(
			cd $ZIMBRA_ROOT/$i || err "failed to create $ZIMBRA_ROOT/$i"
			for i in $ORIGINAL_ZIMBRA_ROOT/$i/*.jar ; do
				ln -sf $i
			done
		)
	done

	## user frontend web container
	local user_lib="mailboxd/webapps/zimbra/WEB-INF/lib"
	mkdir -p $ZIMBRA_ROOT/$user_lib
	(
		cd $ZIMBRA_ROOT/$user_lib
		for i in $ORIGINAL_ZIMBRA_ROOT/$user_lib/*.jar ; do
			ln -sf $i
		done
	)

	## admin backend web containr
	local admin_lib="mailboxd/webapps/zimbraAdmin/WEB-INF/lib"
	mkdir -p $ZIMBRA_ROOT/$admin_lib
	(
		cd $ZIMBRA_ROOT/$admin_lib
		for i in $ORIGINAL_ZIMBRA_ROOT/$admin_lib/*.jar ; do
			ln -sf $i
		done
	)

	## service web containr
	local service_lib="mailboxd/webapps/service/WEB-INF/lib"
	mkdir -p $ZIMBRA_ROOT/$service_lib
	(
		cd $ZIMBRA_ROOT/$service_lib
		for i in $ORIGINAL_ZIMBRA_ROOT/$service_lib/*.jar ; do
			ln -sf $i
		done
	)

	SRCLIST=$ZIMBRA_ROOT/extensions-extra/zmpkg/etc/apt/sources.list

	## add vnc public repo key and configure repos
	zm-apt-key add $ZIMBRA_ROOT/extensions-extra/zmpkg/etc/apt/zcs-repo-master.key

	echo "## vnc standard repos for $ZIMBRA_BASE" >> $SRCLIST
	echo "deb http://packages.vnc.biz/zmpkg/current	$ZIMBRA_BASE	free restricted commercial" >> $SRCLIST
	echo "deb http://packages.vnc.biz/zmpkg/testing	$ZIMBRA_BASE	free restricted commercial" >> $SRCLIST
	echo "" >> $SRCLIST

	## upgrade to latest base packages
	$ZIMBRA_ROOT/bin/zm-apt-get update && $ZIMBRA_ROOT/bin/zm-apt-get upgrade -y
}

zmpkg_devinit "$@"
